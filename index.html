<!DOCTYPE html>
<html lang="vi" data-theme="light">
<head>
  <meta charset="UTF-8" />
  <title>PROJECT DASHBOARD</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />

  <!-- Favicon (tùy chọn: thêm file bk_logo.png) -->
  <link rel="icon" type="image/png" href="bk_logo.png">

  <!-- Libs -->
  <script src="https://unpkg.com/mqtt/dist/mqtt.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

  <style>
    /* ===== THEME ===== */
    :root{
      --bg:#0b1220; --card:#0f172a; --muted:#94a3b8; --line:#1f2a44;
      --text:#e5e7eb; --brand:#22d3ee; --brand-2:#818cf8; --accent:#34d399; --danger:#ef4444;
      --btn:#1f2937; --btn-text:#e5e7eb; --shadow:0 8px 30px rgba(2,8,23,.3);
      --ring:0 0 0 3px rgba(34,211,238,.25);
    }
    [data-theme="light"]{
      --bg:#f5f7fb; --card:#ffffff; --muted:#64748b; --line:#e5e7eb;
      --text:#0f172a; --brand:#06b6d4; --brand-2:#6366f1; --accent:#10b981; --danger:#ef4444;
      --btn:#111827; --btn-text:#ffffff; --shadow:0 10px 28px rgba(2,8,23,.08);
      --ring:0 0 0 3px rgba(99,102,241,.18);
    }

    /* ===== GLOBAL ===== */
    *{box-sizing:border-box}
    body{margin:0; font-family: Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial; color:var(--text); background:radial-gradient(1200px 800px at 10% -10%, rgba(99,102,241,.12), transparent 60%), radial-gradient(1000px 700px at 100% 0%, rgba(45,212,191,.12), transparent 60%), var(--bg)}
    a{color:inherit}

    /* ===== HEADER ===== */
    .header{
      position:sticky; top:0; z-index:10;
      background:linear-gradient(90deg, rgba(99,102,241,.15), rgba(34,211,238,.15));
      backdrop-filter: blur(10px);
      border-bottom:1px solid var(--line);
      padding:14px 18px; display:flex; align-items:center; gap:14px;
    }
    .logo{width:30px; height:30px; border-radius:8px; background:linear-gradient(135deg,var(--brand),var(--brand-2)); display:grid; place-items:center; color:white; font-weight:700; box-shadow: var(--shadow)}
    .title{font-size:18px; font-weight:700; letter-spacing:.3px}
    .status-pill{
      margin-left:auto; font-size:12px; font-weight:600; color:#fff; padding:6px 10px; border-radius:999px;
      background:linear-gradient(90deg, #fb7185, #ef4444);
      box-shadow: var(--shadow);
    }
    .status-ok{ background: linear-gradient(90deg,#22c55e,#10b981); }

    .toggle{
      margin-left:12px; display:flex; align-items:center; gap:8px; font-size:12px; color:var(--muted);
    }
    .switch{
      appearance:none; width:46px; height:26px; background:#00000040; border:1px solid var(--line); border-radius:999px; position:relative; cursor:pointer;
      outline:none; transition:.2s;
    }
    .switch:after{
      content:""; position:absolute; top:2px; left:2px; width:22px; height:22px; border-radius:50%; background:#fff; transition:.2s;
      box-shadow:0 2px 6px rgba(0,0,0,.25);
    }
    .switch:checked{ background:linear-gradient(90deg,var(--brand),var(--brand-2)); box-shadow: var(--ring); }
    .switch:checked:after{ left:22px; }

    /* ===== LAYOUT ===== */
    .wrap{ padding:18px; display:grid; grid-template-columns: 390px 1fr; gap:18px; }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)) , var(--card);
      border:1px solid var(--line); border-radius:16px; padding:16px; box-shadow: var(--shadow);
    }
    .card h3{ margin:0 0 10px 0; font-size:14px; color:var(--muted); text-transform:uppercase; letter-spacing:.12em; }

    .row{ display:flex; gap:10px; }
    .row>*{ flex:1; }
    label{ display:block; font-size:12px; color:var(--muted); margin:8px 0 6px; }
    input, textarea{
      width:100%; padding:10px 12px; border:1px solid var(--line); border-radius:12px; font-size:14px; color:var(--text);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)) , var(--card);
      outline:none; transition:.15s;
    }
    input:focus, textarea:focus{ box-shadow: var(--ring); border-color: transparent; }
    textarea{ min-height:96px; resize:vertical; }

    .btn{ padding:10px 12px; border:1px solid transparent; background:linear-gradient(90deg,var(--brand),var(--brand-2)); color:#fff; border-radius:12px; cursor:pointer; font-weight:600; box-shadow: var(--shadow); }
    .btn:hover{ filter:brightness(1.05); }
    .btn.secondary{ background:transparent; color:var(--text); border-color:var(--line); }
    .btn.danger{ background: linear-gradient(90deg,#fb7185,#ef4444); }

    #log{
      height:140px; overflow:auto; border:1px dashed var(--line); border-radius:12px; padding:10px; font-family: ui-monospace, Menlo, Consolas, monospace; font-size:12px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,0)) , var(--card);
    }

    table{ width:100%; border-collapse:collapse; font-size:13px; }
    th, td{ border-bottom:1px solid var(--line); padding:10px 8px; text-align:left; }
    thead th{ font-size:12px; color:var(--muted); text-transform:uppercase; letter-spacing:.1em; }
    tbody tr:hover{ background: rgba(99,102,241,.06); }

    .charts{ display:grid; grid-template-columns: repeat(2,1fr); gap:12px; }
    .chart-box{ border:1px solid var(--line); border-radius:14px; padding:10px; background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,0)) , var(--card); }
    .chart-title{ margin:0 0 8px; font-size:13px; color:var(--muted); }

    @media (max-width: 1100px){ .wrap{ grid-template-columns: 1fr; } .charts{ grid-template-columns:1fr; } }
  </style>
</head>
<body>
  <!-- HEADER -->
  <div class="header">
    <div class="title">PROJECT DASHBOARD</div>
    <div id="statusPill" class="status-pill">Disconnected</div>
    <label class="toggle">
      <span>Dark Mode</span>
      <input id="themeSwitch" type="checkbox" class="switch">
    </label>
  </div>

  <!-- CONTENT -->
  <div class="wrap">
    <!-- LEFT: CONTROLS -->
    <div class="card">
      <h3>Connection</h3>

      <label>Broker WebSocket URL</label>
      <input id="brokerUrl" placeholder="wss://test.mosquitto.org:8081/mqtt" />

      <div class="row">
        <div>
          <label>Username</label>
          <input id="username" placeholder="username" />
        </div>
        <div>
          <label>Password</label>
          <input id="password" type="password" placeholder="password" />
        </div>
      </div>

      <label>Subscribe Topic</label>
      <input id="topic" placeholder="vd: test/topic/#" />

      <div class="row" style="margin-top:10px">
        <button id="btnConnect" class="btn">Connect</button>
        <button id="btnDisconnect" class="btn secondary">Disconnect</button>
      </div>

      <h3 style="margin-top:16px">Publish</h3>
      <label>Publish Topic</label>
      <input id="pubTopic" placeholder="vd: test/topic/dashboard" />
      <label>Message (JSON)</label>
      <textarea id="pubMessage" placeholder='{"rpm":1600,"force":120,"sound":55,"vibration":1.2}'></textarea>
      <div style="margin-top:8px">
        <button id="btnPublish" class="btn">Send</button>
      </div>

      <h3 style="margin-top:16px">Export & Data</h3>
      <div class="row">
        <button id="btnExportXlsx" class="btn">Export Excel</button>
        <button id="btnExportCsv" class="btn secondary">Export CSV</button>
      </div>
      <div class="row" style="margin-top:8px">
        <button id="btnClearData" class="btn danger">Clear Data</button>
        <div style="display:flex; align-items:center; justify-content:flex-end; color:var(--muted); font-weight:600;">
          <span id="countLabel">0 rows</span>
        </div>
      </div>

      <h3 style="margin-top:16px">Console</h3>
      <div id="log"></div>
    </div>

    <!-- RIGHT: CHARTS + TABLE -->
    <div class="card">
      <h3>Realtime</h3>
      <div class="charts" style="margin-bottom:12px">
        <div class="chart-box"><p class="chart-title">RPM</p><canvas id="chart_rpm" height="120"></canvas></div>
        <div class="chart-box"><p class="chart-title">Force</p><canvas id="chart_force" height="120"></canvas></div>
        <div class="chart-box"><p class="chart-title">Sound</p><canvas id="chart_sound" height="120"></canvas></div>
        <div class="chart-box"><p class="chart-title">Vibration</p><canvas id="chart_vibration" height="120"></canvas></div>
      </div>

      <h3>Latest Messages</h3>
      <table>
        <thead>
          <tr>
            <th>time</th>
            <th>topic</th>
            <th>rpm</th>
            <th>force</th>
            <th>sound</th>
            <th>vibration</th>
          </tr>
        </thead>
        <tbody id="msgTableBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    /* ===== THEME SWITCH ===== */
    const themeSwitch = document.getElementById("themeSwitch");
    const savedTheme = localStorage.getItem("theme_mode");
    if(savedTheme){ document.documentElement.setAttribute("data-theme", savedTheme); themeSwitch.checked = savedTheme !== "light"; }
    themeSwitch.addEventListener("change", ()=>{
      const mode = themeSwitch.checked ? "dark" : "light";
      document.documentElement.setAttribute("data-theme", mode);
      localStorage.setItem("theme_mode", mode);
    });

    /* ===== SHORTCUTS ===== */
    const el = id => document.getElementById(id);
    const logBox = el("log"), tableBody = el("msgTableBody"), countLabel = el("countLabel");
    const statusPill = el("statusPill");
    function log(m){ const t=new Date().toLocaleTimeString(); logBox.textContent += `[${t}] ${m}\n`; logBox.scrollTop=logBox.scrollHeight; }
    function setStatus(ok, txt){
      statusPill.textContent = txt || (ok ? "Connected" : "Disconnected");
      statusPill.className = "status-pill " + (ok ? "status-ok" : "");
    }

    /* ===== STORAGE with QUOTA handling ===== */
    const STORAGE_KEY = "project_dashboard_data";
    let rows = [];
    window.addEventListener("load", ()=>{
      const saved = localStorage.getItem(STORAGE_KEY);
      if(saved){
        try{
          rows = JSON.parse(saved) || [];
          rows.forEach(r=>{ addRowToTable(r); pushToCharts(r); });
          countLabel.textContent = `${rows.length} rows`;
          log(`Restored ${rows.length} rows from localStorage`);
        }catch{ rows = []; }
      }
    });
    function safeSave(){
      try{ localStorage.setItem(STORAGE_KEY, JSON.stringify(rows)); return true; }
      catch{ return false; }
    }
    function onQuotaExceeded(){
      alert("⚠️ Bộ nhớ trình duyệt đã đầy!\nHệ thống sẽ xuất Excel rồi làm trống để tiếp tục.");
      exportXLSX(); clearData();
    }

    /* ===== TABLE/CHARTS ===== */
    function num(v){ return (typeof v==="number" && isFinite(v)) ? v : ""; }
    function addRowToTable(o){
      const tr = document.createElement("tr");
      tr.innerHTML = `<td>${o.time}</td><td>${o.topic}</td><td>${num(o.rpm)}</td><td>${num(o.force)}</td><td>${num(o.sound)}</td><td>${num(o.vibration)}</td>`;
      tableBody.prepend(tr);
      if(tableBody.children.length>200) tableBody.removeChild(tableBody.lastChild);
    }
    function addRow(o){
      rows.push(o);
      countLabel.textContent = `${rows.length} rows`;
      addRowToTable(o); pushToCharts(o);
      if(!safeSave()) onQuotaExceeded();
    }

    // Charts
    const baseOpts = (label)=>({
      type:"line",
      data:{ labels:[], datasets:[{ label, data:[], pointRadius:0, borderWidth:2, tension:.25 }]},
      options:{
        responsive:true, animation:false,
        plugins:{ legend:{ display:false } },
        scales:{ x:{ display:false }, y:{ ticks:{ color:getComputedStyle(document.documentElement).getPropertyValue('--muted') } } }
      }
    });
    const charts = {
      rpm: new Chart(el("chart_rpm"), baseOpts("rpm")),
      force: new Chart(el("chart_force"), baseOpts("force")),
      sound: new Chart(el("chart_sound"), baseOpts("sound")),
      vibration: new Chart(el("chart_vibration"), baseOpts("vibration")),
    };
    const MAX_POINTS = 300;
    function pushToCharts(row){
      const t = new Date(row.time).toLocaleTimeString();
      [["rpm","rpm"],["force","force"],["sound","sound"],["vibration","vibration"]].forEach(([k,n])=>{
        const ch = charts[k]; const v = row[k];
        if(typeof v==="number" && isFinite(v)){
          ch.data.labels.push(t);
          ch.data.datasets[0].data.push(v);
          if(ch.data.labels.length>MAX_POINTS){ ch.data.labels.shift(); ch.data.datasets[0].data.shift(); }
          ch.update();
        }
      });
    }

    function clearData(){
      rows=[]; tableBody.innerHTML=""; countLabel.textContent="0 rows";
      localStorage.removeItem(STORAGE_KEY);
      Object.values(charts).forEach(ch=>{ ch.data.labels=[]; ch.data.datasets[0].data=[]; ch.update(); });
      log("Data cleared");
    }

    /* ===== MQTT ===== */
    let client=null;
    function connect(){
      const url = el("brokerUrl").value.trim();
      const topic = el("topic").value.trim();
      const username = el("username").value.trim();
      const password = el("password").value;
      if(!url || !topic){ alert("Broker URL & Topic required"); return; }
      if(location.protocol==="https:" && url.startsWith("ws://")){
        alert("Trang đang chạy HTTPS. Hãy dùng WSS (vd: wss://test.mosquitto.org:8081/mqtt)."); return;
      }
      if(client) try{ client.end(true); }catch{}
      const opts={ clientId:"web-"+Math.random().toString(16).slice(2), clean:true };
      if(username) opts.username=username; if(password) opts.password=password;
      client = mqtt.connect(url, opts);
      log("Connecting ...");
      client.on("connect", ()=>{ setStatus(true,"Connected"); log("Connected ✓"); client.subscribe(topic, err=>{ if(err) log("Subscribe error:"+err); else log("Subscribed: "+topic); }); });
      client.on("message", (t,msg)=>{
        let row={ time:new Date().toISOString(), topic:t };
        try{ const js=JSON.parse(msg.toString()); if(js && typeof js==="object"){ row.rpm=js.rpm; row.force=js.force; row.sound=js.sound; row.vibration=js.vibration; } }catch{}
        addRow(row);
      });
      client.on("close", ()=>{ setStatus(false,"Disconnected"); log("Closed"); });
      client.on("error", e=>{ setStatus(false,"Error"); log("Error: "+e.message); });
    }
    function disconnect(){ if(client){client.end(true);} setStatus(false,"Disconnected"); log("Disconnected."); }
    function publish(){
      if(!client || !client.connected){ alert("Not connected"); return; }
      const t = el("pubTopic").value.trim();
      const m = el("pubMessage").value.trim();
      if(!t || !m){ alert("Enter publish topic and message"); return; }
      client.publish(t, m);
      log("📤 Published → "+t+": "+m);
    }

    /* ===== EXPORT ===== */
    function exportCSV(){
      if(rows.length===0){ alert("No data"); return; }
      const headers=["time","topic","rpm","force","sound","vibration"];
      const csv=[headers.join(",")];
      rows.forEach(r=>{
        csv.push(headers.map(h=>{
          const v=(r[h]??""); const s=String(v).replace(/"/g,'""'); return /[",\n]/.test(s)?`"${s}"`:s;
        }).join(","));
      });
      const blob=new Blob([csv.join("\n")],{type:"text/csv;charset=utf-8"});
      const a=document.createElement("a");
      a.href=URL.createObjectURL(blob);
      a.download=`project_data_${new Date().toISOString().replace(/[:.]/g,"-")}.csv`;
      a.click(); URL.revokeObjectURL(a.href);
    }
    function exportXLSX(){
      if(rows.length===0){ alert("No data"); return; }
      const ws=XLSX.utils.json_to_sheet(rows);
      const wb=XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb,ws,"data");
      XLSX.writeFile(wb,`project_data_${new Date().toISOString().slice(0,19).replace(/[:T]/g,"-")}.xlsx`);
    }

    /* ===== BIND ===== */
    el("btnConnect").onclick = connect;
    el("btnDisconnect").onclick = disconnect;
    el("btnPublish").onclick = publish;
    el("btnClearData").onclick = clearData;
    el("btnExportCsv").onclick = exportCSV;
    el("btnExportXlsx").onclick = exportXLSX;
  </script>
</body>
</html>
